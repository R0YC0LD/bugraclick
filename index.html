<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sativa Master | Ultimate Rolling</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-green: #39ff14;
            --neon-blue: #00f7ff;
            --deep-bg: #020202;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-drag: none; }

        body {
            background-color: var(--deep-bg);
            color: white;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            width: 100vw; height: 100vh;
        }

        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        .interactive-element { pointer-events: auto; transition: all 0.3s ease; }

        h1 {
            font-family: 'Orbitron', sans-serif; font-size: 4rem; text-transform: uppercase;
            color: transparent; -webkit-text-stroke: 2px var(--neon-green);
            text-shadow: 0 0 30px rgba(57, 255, 20, 0.4); margin-bottom: 10px; text-align: center;
        }

        .btn-main {
            background: rgba(57, 255, 20, 0.05); border: 2px solid var(--neon-green);
            color: var(--neon-green); padding: 15px 40px; font-size: 1.2rem;
            font-family: 'Orbitron', sans-serif; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.1); letter-spacing: 2px;
        }
        .btn-main:hover { background: var(--neon-green); color: black; box-shadow: 0 0 40px var(--neon-green); }

        /* SARMA AŞAMASI UI */
        .instruction-container {
            position: absolute; bottom: 15%; text-align: center; width: 100%;
        }
        .key-hint {
            display: inline-block; border: 2px solid var(--neon-green); padding: 10px 20px;
            background: rgba(0,0,0,0.7); color: var(--neon-green); font-family: 'Orbitron';
            font-weight: bold; font-size: 1.2rem; box-shadow: 0 0 15px var(--neon-green);
            animation: pulse 1s infinite alternate;
        }
        .sub-hint { margin-top: 10px; font-size: 0.9rem; opacity: 0.7; letter-spacing: 1px; }

        /* SMOKING UI */
        .smoke-controls {
            position: absolute; bottom: 10%; text-align: center; display: none;
            font-family: 'Orbitron'; font-size: 1rem; line-height: 1.8;
        }
        .smoke-key { color: var(--neon-blue); border-bottom: 1px solid var(--neon-blue); }

        @keyframes pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.05); opacity: 1; } }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:999; display:flex; justify-content:center; align-items:center; color:var(--neon-green); font-family:'Orbitron'; letter-spacing:3px;}
    </style>
</head>
<body>
    <div id="loader">SİSTEM BAŞLATILIYOR...</div>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="hero-section" class="interactive-element" style="text-align:center;">
            <h1>SATIVA MASTER</h1>
            <p style="letter-spacing: 4px; margin-bottom: 40px; color: var(--neon-blue);">SİBERNETİK SARMA DENEYİMİ</p>
            <button class="btn-main" id="start-btn">DENEYİME BAŞLA</button>
        </div>

        <div id="rolling-ui" class="instruction-container" style="display:none;">
            <div class="key-hint">BOŞLUK (SPACE) BASILI TUT</div>
            <div class="sub-hint">ELLERİNLE SARMAK İÇİN BASILI TUTUN</div>
        </div>

        <div id="smoking-ui" class="smoke-controls">
            <div><span class="smoke-key">SOL TIK</span> BASILI TUT: DUMANI ÇEK</div>
            <div><span class="smoke-key">BIRAK</span>: ÜFLE</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // --- YAPILANDIRMA ---
        const CONFIG = {
            colors: { bg: 0x020202, neonGreen: 0x39ff14, neonBlue: 0x00f7ff, paper: 0xeeeeee, mix: 0x2d5a27 },
            Hands: { startX: 6, endX: 1.8 }, // Ellerin başlangıç ve bitiş X konumu
        };

        let scene, camera, renderer;
        let handLeft, handRight; // Eller
        let rollingStage, looseMixParticles, finishedJoint; // Sarma aşaması objeleri
        let emberMesh, smokeParticles = [], smokeTexture;
        let mouse = new THREE.Vector2();

        const STATE = {
            current: 'LOADING', // LOADING, INTRO, ROLLING, SMOKING
            rollProgress: 0, // 0.0 - 1.0 arası
            isSpacePressed: false,
            isInhaling: false,
            jointLength: 4
        };

        // --- INIT ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.colors.bg);
            scene.fog = new THREE.FogExp2(CONFIG.colors.bg, 0.015);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 2, 15);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            setupLights();
            smokeTexture = createSmokeTexture();

            // --- NESNELERİ OLUŞTUR ---
            createStylizedHands();
            createRollingStage();
            createFinishedJoint();

            // --- EVENT LISTENERS ---
            window.addEventListener('resize', onResize);
            window.addEventListener('mousemove', onMouseMove);
            document.getElementById('start-btn').addEventListener('click', startRollingPhase);

            // Space Tuşu Kontrolü
            document.addEventListener('keydown', (e) => {
                if(STATE.current === 'ROLLING' && e.code === 'Space') STATE.isSpacePressed = true;
            });
            document.addEventListener('keyup', (e) => {
                if(STATE.current === 'ROLLING' && e.code === 'Space') STATE.isSpacePressed = false;
            });
            // Mobil Destek
            document.addEventListener('touchstart', () => { if(STATE.current === 'ROLLING') STATE.isSpacePressed = true; });
            document.addEventListener('touchend', () => { if(STATE.current === 'ROLLING') STATE.isSpacePressed = false; });

            // İçme Kontrolleri
            document.addEventListener('mousedown', startInhale);
            document.addEventListener('mouseup', stopInhale);

            document.getElementById('loader').style.display = 'none';
            STATE.current = 'INTRO';
            animate();
        }

        function setupLights() {
            scene.add(new THREE.AmbientLight(0xffffff, 0.2));
            const spot = new THREE.SpotLight(CONFIG.colors.neonGreen, 2);
            spot.position.set(0, 10, 5); spot.castShadow = true; scene.add(spot);
            const blueRim = new THREE.PointLight(CONFIG.colors.neonBlue, 1);
            blueRim.position.set(-5, 2, -5); scene.add(blueRim);
            const greenRim = new THREE.PointLight(CONFIG.colors.neonGreen, 1);
            greenRim.position.set(5, 2, -5); scene.add(greenRim);
        }

        // --- 3D MODELLER: ELLER VE SARMA ---

        // Stilize Neon Eller (Prosedürel)
        function createStylizedHands() {
            const handMat = new THREE.MeshStandardMaterial({ 
                color: 0x111111, metalness: 0.8, roughness: 0.2,
                emissive: CONFIG.colors.neonGreen, emissiveIntensity: 0.2
            });
            const wireMat = new THREE.MeshBasicMaterial({ color: CONFIG.colors.neonGreen, wireframe: true });

            function buildHand(isLeft) {
                const group = new THREE.Group();
                // Avuç içi
                const palmGeo = new THREE.BoxGeometry(1.5, 2, 0.5);
                const palm = new THREE.Mesh(palmGeo, handMat);
                palm.add(new THREE.Mesh(palmGeo, wireMat)); // Neon çerçeve
                group.add(palm);

                // Parmaklar (Basit bloklar)
                for(let i=0; i<4; i++) {
                    const fingerGeo = new THREE.BoxGeometry(0.3, 1.5, 0.3);
                    const finger = new THREE.Mesh(fingerGeo, handMat);
                    finger.position.set((i-1.5)*0.4, 1.8, 0);
                    group.add(finger);
                }
                // Başparmak
                const thumbGeo = new THREE.BoxGeometry(0.4, 1.2, 0.3);
                const thumb = new THREE.Mesh(thumbGeo, handMat);
                thumb.position.set(isLeft ? 0.8 : -0.8, 0.5, 0.5);
                thumb.rotation.z = isLeft ? -0.5 : 0.5;
                group.add(thumb);

                return group;
            }

            handLeft = buildHand(true);
            handLeft.position.set(-CONFIG.Hands.startX, 0, 0);
            handLeft.rotation.y = Math.PI / 2; // İçe dönük

            handRight = buildHand(false);
            handRight.position.set(CONFIG.Hands.startX, 0, 0);
            handRight.rotation.y = -Math.PI / 2;

            scene.add(handLeft, handRight);
        }

        // Sarma Aşaması (Açık Kağıt + Karışım)
        function createRollingStage() {
            rollingStage = new THREE.Group();

            // Açık Kağıt (Düzlem)
            const paperGeo = new THREE.PlaneGeometry(4, 2.5);
            const paperMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.paper, side: THREE.DoubleSide });
            const paper = new THREE.Mesh(paperGeo, paperMat);
            paper.rotation.x = -Math.PI / 2; // Yatay
            rollingStage.add(paper);

            // Kenevir Karışımı (Parçacıklar)
            const mixGeo = new THREE.BufferGeometry();
            const particleCount = 300;
            const positions = new Float32Array(particleCount * 3);
            for(let i=0; i<particleCount; i++) {
                positions[i*3] = (Math.random() - 0.5) * 3.5; // X (Kağıt boyunca)
                positions[i*3+1] = Math.random() * 0.3;       // Y (Yükseklik)
                positions[i*3+2] = (Math.random() - 0.5) * 1.5; // Z (Derinlik)
            }
            mixGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const mixMat = new THREE.PointsMaterial({ color: CONFIG.colors.mix, size: 0.08 });
            looseMixParticles = new THREE.Points(mixGeo, mixMat);
            rollingStage.add(looseMixParticles);

            rollingStage.position.y = -1;
            rollingStage.visible = false;
            scene.add(rollingStage);
        }

        // Bitmiş Joint
        function createFinishedJoint() {
            finishedJoint = new THREE.Group();
            // Gövde
            const bodyGeo = new THREE.CylinderGeometry(0.2, 0.2, STATE.jointLength, 32);
            bodyGeo.translate(0, STATE.jointLength/2, 0); // Pivot altta
            const bodyMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.paper });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            finishedJoint.add(body);

            // Köz
            const emberGeo = new THREE.SphereGeometry(0.18, 16, 16);
            emberMesh = new THREE.Mesh(emberGeo, new THREE.MeshStandardMaterial({ color: 0x111111, emissive: 0xff3300, emissiveIntensity: 0 }));
            emberMesh.position.y = STATE.jointLength;
            emberMesh.add(new THREE.PointLight(0xff3300, 0, 3));
            finishedJoint.add(emberMesh);

            finishedJoint.rotation.z = Math.PI / 2;
            finishedJoint.position.y = -1;
            finishedJoint.visible = false;
            scene.add(finishedJoint);
        }

        // --- OYUN AKIŞI ---

        function startRollingPhase() {
            STATE.current = 'ROLLING';
            document.getElementById('hero-section').style.display = 'none';
            document.getElementById('rolling-ui').style.display = 'block';

            rollingStage.visible = true;
            gsap.to(camera.position, { z: 10, y: 3, duration: 1.5, ease: "power2.inOut" });
            gsap.to(rollingStage.position, { y: 0, duration: 1 });

            // Elleri başlangıç konumuna getir
            gsap.to(handLeft.position, { x: -CONFIG.Hands.startX, y: 0.5, z: 1, duration: 1 });
            gsap.to(handRight.position, { x: CONFIG.Hands.startX, y: 0.5, z: 1, duration: 1 });
        }

        // SARMA MANTIĞI (Animasyon Döngüsünde Çalışır)
        function updateRollingState() {
            if (STATE.current !== 'ROLLING') return;

            const targetProgress = STATE.isSpacePressed ? 1 : 0;
            // İlerleme durumunu yumuşakça değiştir
            STATE.rollProgress = THREE.MathUtils.lerp(STATE.rollProgress, targetProgress, 0.05);

            // 1. Ellerin Hareketi
            const currentHandX = THREE.MathUtils.lerp(CONFIG.Hands.startX, CONFIG.Hands.ExprNode, STATE.rollProgress);
            handLeft.position.x = -currentHandX;
            handRight.position.x = currentHandX;

            // Ellerin hafif rotasyonu (sarma hareketi gibi)
            handLeft.rotation.z = STATE.rollProgress * -0.5;
            handRight.rotation.z = STATE.rollProgress * 0.5;

            // 2. Karışımın Sıkışması (Parçacık Efekti)
            const positions = looseMixParticles.geometry.attributes.position.array;
            for(let i=0; i < positions.length; i+=3) {
                // X ekseninde merkeze toplan
                positions[i] = positions[i] * (1 - STATE.rollProgress * 0.1); 
                // Z ekseninde silindir formuna gir
                positions[i+2] = positions[i+2] * (1 - STATE.rollProgress * 0.8);
            }
            looseMixParticles.geometry.attributes.position.needsUpdate = true;

            // 3. Kağıdın Büzülmesi (Basit scale hilesi)
            rollingStage.scale.x = 1 - (STATE.rollProgress * 0.7);

            // TAMAMLANMA KONTROLÜ
            if (STATE.rollProgress > 0.98) {
                completeRolling();
            }
        }

        function completeRolling() {
            STATE.current = 'TRANSITION';
            document.getElementById('rolling-ui').style.display = 'none';

            const tl = gsap.timeline({ onComplete: startSmokingPhase });

            // Eller geri çekilsin
            tl.to(handLeft.position, { x: -8, duration: 0.5 });
            tl.to(handRight.position, { x: 8, duration: 0.5 }, "<");
            
            // Sarma sahnesi kaybolsun, joint gelsin
            tl.to(rollingStage.scale, { x: 0.1, y: 0.1, z: 0.1, duration: 0.5, onComplete: () => {
                rollingStage.visible = false;
                finishedJoint.visible = true;
                finishedJoint.scale.set(0,0,0);
            }}, "-=0.3");
            
            // Joint ortaya çıksın
            tl.to(finishedJoint.scale, { x:1, y:1, z:1, duration: 1, ease: "elastic.out" });
        }

        function startSmokingPhase() {
            STATE.current = 'SMOKING';
            document.getElementById('smoking-ui').style.display = 'block';
            gsap.to(camera.position, { z: 8, y: 1, duration: 1 });
        }

        // İÇME MANTIĞI
        function startInhale() {
            if(STATE.current !== 'SMOKING') return;
            STATE.isInhaling = true;
            gsap.to(camera.position, { z: 6, duration: 0.5 });
            gsap.to(finishedJoint.position, { y: -0.5, x:0, duration: 0.5 });
            gsap.to(emberMesh.material, { emissiveIntensity: 3, duration: 0.2 });
            emberMesh.children[0].intensity = 3;
        }

        function stopInhale() {
            if(STATE.current !== 'SMOKING' || !STATE.isInhaling) return;
            STATE.isInhaling = false;
            gsap.to(camera.position, { z: 8, duration: 1 });
            gsap.to(finishedJoint.position, { y: 0, duration: 1 });
            gsap.to(emberMesh.material, { emissiveIntensity: 0, duration: 0.5 });
            emberMesh.children[0].intensity = 0;
            emitSmoke();
        }

        // --- DUMAN EFEKTİ ---
        function createSmokeTexture() { const c=document.createElement('canvas');c.width=c.height=128;const ctx=c.getContext('2d');const g=ctx.createRadialGradient(64,64,0,64,64,64);g.addColorStop(0,'rgba(255,255,255,0.4)');g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.fillRect(0,0,128,128);return new THREE.CanvasTexture(c);}
        function emitSmoke() {
            for(let i=0; i<20; i++) {
                const mat = new THREE.SpriteMaterial({ map: smokeTexture, color: 0xaaaaaa, transparent: true, opacity: 0.5 });
                const sprite = new THREE.Sprite(mat);
                sprite.position.set((Math.random()-0.5)*2, -2, 4); sprite.scale.set(2,2,2);
                sprite.userData = { vel: new THREE.Vector3(0, 0.05+Math.random()*0.05, 0), life: 1.0 };
                smokeParticles.push(sprite); scene.add(sprite);
            }
        }

        // --- RENDER LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            updateRollingState();

            // Duman Güncelleme
            smokeParticles.forEach((p, i) => {
                p.position.add(p.userData.vel); p.material.opacity = p.userData.life;
                p.scale.addScalar(0.03); p.userData.life -= 0.01;
                if(p.userData.life<=0){ scene.remove(p); smokeParticles.splice(i,1); }
            });

            // Idle Animasyonlar
            if(STATE.current === 'INTRO') {
                handLeft.position.y = Math.sin(performance.now()*0.002)*0.2;
                handRight.position.y = Math.sin(performance.now()*0.002 + 1)*0.2;
            }
            if(STATE.current === 'SMOKING') {
                finishedJoint.rotation.y = THREE.MathUtils.lerp(finishedJoint.rotation.y, mouse.x*0.5, 0.1);
                finishedJoint.rotation.z = THREE.MathUtils.lerp(finishedJoint.rotation.z, Math.PI/2 + mouse.y*0.5, 0.1);
            }

            renderer.render(scene, camera);
        }

        function onResize() { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight);}
        function onMouseMove(e) { mouse.x = (e.clientX/window.innerWidth)*2-1; mouse.y = -(e.clientY/window.innerHeight)*2+1;}
        init();
    </script>
</body>
</html>
